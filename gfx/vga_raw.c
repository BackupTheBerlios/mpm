#define _POSIX_SOURCE
#define _MINIX
#define _SYSTEM

#include <minix/config.h>
#include <minix/com.h>
#include <minix/type.h>
#include <minix/syslib.h>
#include <minix/sysutil.h>
#include <minix/const.h>
#include <ibm/int86.h>
#include <sys/types.h>
#include <sys/vm.h>
#include <errno.h>
#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <stdlib.h>

#define GFX_DRIVER

#include "gfx.h"
#include "gfx_ioctl.h"
#include "vga_raw.h"

#define FB_BASE 0xa0000

EXTERN int debug;

PRIVATE char *myname;

PRIVATE struct mode_list_s {
    gfx_mode_t mode;
    unsigned int fb_off;
    unsigned char bpp, planar;
    vga_raw_mode_t raw_mode;
} mode_list[] = {
    { TEXT_COLOR, 0xb0000 - FB_BASE, 16, 0,
      { { 0x67 },
        { 0x03, 0x00, 0x03, 0x00, 0x02 },
        { 0x5F, 0x4F, 0x50, 0x82, 0x55, 0x81, 0xBF, 0x1F, 0x00, 0x4F, 0x0D,
          0x0E, 0x00, 0x00, 0x00, 0x50, 0x9C, 0x0E, 0x8F, 0x28, 0x1F, 0x96,
          0xB9, 0xA3, 0xFF },
        { 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x0E, 0x00, 0xFF },
        { 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x14, 0x07, 0x38, 0x39, 0x3A,
          0x3B, 0x3C, 0x3D, 0x3E, 0x3F, 0x0C, 0x00, 0x0F, 0x08, 0x00 } } },
    { VGA_640x480x16, 0xa0000 - FB_BASE, 4, 1,
      { { 0xE3 },
        { 0x03, 0x01, 0x08, 0x00, 0x06 },
        { 0x5F, 0x4F, 0x50, 0x82, 0x54, 0x80, 0x0B, 0x3E, 0x00, 0x40, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0xEA, 0x0C, 0xDF, 0x28, 0x00, 0xE7,
          0x04, 0xE3, 0xFF },
        { 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x05, 0x0F, 0xFF },
        { 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x14, 0x07, 0x38, 0x39, 0x3A,
          0x3B, 0x3C, 0x3D, 0x3E, 0x3F, 0x01, 0x00, 0x0F, 0x00, 0x00 } } },
#if 0
    { VGA_720x480x16,
      { { 0xE7 },
        { 0x03, 0x01, 0x08, 0x00, 0x06 },
        { 0x6B, 0x59, 0x5A, 0x82, 0x60, 0x8D, 0x0B, 0x3E, 0x00, 0x40, 0x06,
          0x07, 0x00, 0x00, 0x00, 0x00, 0xEA, 0x0C, 0xDF, 0x2D, 0x08, 0xE8,
          0x05, 0xE3, 0xFF },
        { 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x05, 0x0F, 0xFF },
        { 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A,
          0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x01, 0x00, 0x0F, 0x00, 0x00 } } },
#endif
    { VGA_320x200x256, 0xa0000 - FB_BASE, 8, 0,
      { { 0x63 },
        { 0x03, 0x01, 0x0F, 0x00, 0x0E },
        { 0x5F, 0x4F, 0x50, 0x82, 0x54, 0x80, 0xBF, 0x1F, 0x00, 0x41, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x9C, 0x0E, 0x8F, 0x28, 0x40, 0x96,
          0xB9, 0xA3, 0xFF },
        { 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x05, 0x0F, 0xFF },
        { 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A,
          0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x41, 0x00, 0x0F, 0x00, 0x00 } } },
    { GFX_MODE_NONE, 0xa0000 - FB_BASE, 0, 0,
      { { 0x67 },
        { 0x03, 0x00, 0x03, 0x00, 0x02 },
        { 0x5F, 0x4F, 0x50, 0x82, 0x55, 0x81, 0xBF, 0x1F, 0x00, 0x4F, 0x0D,
          0x0E, 0x00, 0x00, 0x00, 0x50, 0x9C, 0x0E, 0x8F, 0x28, 0x1F, 0x96,
          0xB9, 0xA3, 0xFF },
        { 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x0E, 0x00, 0xFF },
        { 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x14, 0x07, 0x38, 0x39, 0x3A,
          0x3B, 0x3C, 0x3D, 0x3E, 0x3F, 0x0C, 0x00, 0x0F, 0x08, 0x00 } } },
};

PRIVATE unsigned char *fb, *afb, *curfb;

PRIVATE int init(char *name) {
    int d, r;

    myname = name;

    afb = malloc(0x20000 + PAGE_SIZE);
    if (afb == NULL) panic(myname, "out of memory", errno);

    fb = afb;
    d = ((unsigned)fb % PAGE_SIZE);
    if (d) fb = (unsigned char *) fb + (PAGE_SIZE - d);

    r = sys_vm_map(SELF, 1, (phys_bytes)fb, 0x20000, 0xa0000);
    if (r != OK) panic(myname, "sys_vm_map failed", r);

    curfb = fb;

    return 0;
}

#define WRITE_RANGE(num, idx, dta, ary) \
    for (i=0; i<num; i++) { \
        sys_outb(idx, i); \
        sys_outb(dta, ary[i]); \
    }

PRIVATE int set_mode(gfx_mode_t mode) {
    unsigned long lv;
    int x, r, i;
    vga_raw_mode_t *rm;

    for (x=0; mode_list[x].mode != GFX_MODE_NONE; x++) {
        if (mode == mode_list[x].mode) break;
    }
    if (mode_list[x].mode == GFX_MODE_NONE) return EGFX_UNSUPPORTED_MODE;
    rm = &mode_list[x].raw_mode;

    sys_outb(VGA_MISC_WRITE, rm->misc[0]);
    WRITE_RANGE(VGA_NUM_SEQ_REGS, VGA_SEQ_INDEX, VGA_SEQ_DATA, rm->seq);
 
    /* unlock CRTC registers and keep them unlocked */
    sys_outb(VGA_CRTC_INDEX, 0x03);
    sys_inb(VGA_CRTC_DATA, &lv);
    sys_outb(VGA_CRTC_DATA, lv | 0x80);
    sys_outb(VGA_CRTC_INDEX, 0x11);
    sys_inb(VGA_CRTC_DATA, &lv);
    sys_outb(VGA_CRTC_DATA, lv & ~0x80);
    rm->crtc[0x03] |= 0x80;
    rm->crtc[0x11] &= ~0x80;

    WRITE_RANGE(VGA_NUM_CRTC_REGS, VGA_CRTC_INDEX, VGA_CRTC_DATA, rm->crtc);
    WRITE_RANGE(VGA_NUM_GC_REGS, VGA_GC_INDEX, VGA_GC_DATA, rm->gc);

    for (i=0; i<VGA_NUM_AC_REGS; i++) {
        sys_inb(VGA_INSTAT_READ, &lv);
        sys_outb(VGA_AC_INDEX, i);
        sys_outb(VGA_AC_WRITE, rm->ac[i]);
    }

    curfb = &fb[mode_list[x].fb_off];

    return 0;
}

PRIVATE int get_pixel(unsigned short x, unsigned short y, unsigned int *c) {
    return 0;
}

PRIVATE int put_pixel(unsigned short x, unsigned short y, unsigned int c) {
    return 0;
}

PRIVATE int clear_screen(void) {
    return 0;
}

PRIVATE int draw_line(unsigned short x1, unsigned short y1,
                      unsigned short x2, unsigned short y2,
                      unsigned int c) {
    return 0;
}

PRIVATE int draw_line_hori(unsigned short x1, unsigned short y1,
                           unsigned short x2,
                           unsigned int c) {
    return 0;
}

PRIVATE int draw_line_vert(unsigned short x1, unsigned short y1,
                                              unsigned short y2,
                           unsigned int c) {
    return 0;
}

PUBLIC gfx_funcs_t gfx_funcs_vga_raw = {
    "vga_raw",
    TEXT_COLOR | VGA_640x480x16 | VGA_320x200x256,
    init,
    set_mode,
    get_pixel,
    put_pixel,
    clear_screen,
    draw_line,
    draw_line_hori,
    draw_line_vert
};
